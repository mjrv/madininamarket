{% extends 'shop.html.twig' %}

{% block body %}
	<div class="col-xs-12 text-center">
		<h5 class="text-danger">Dernier rafraichissement: <span id="date"></span></h5>
		{# <form action="" method="GET" class="form-horizontal"> #}
			<h5>Choix par date</h5>
			<select name="periode" id="periode" class="selectpicker">
				<option value="1">Depuis le debut</option>
				<option value="2">Jour</option>
				<option value="3">Semaine</option>
				<option value="4">Mois</option>
				<option value="5">Année</option>
				<option value="6">Période indiqué</option>
			</select>
			<br>
			<br>

			<div id="custom" style="display: none">
				<div class="col-xs-6" >
					Debut: <input type="text" name="start" id="start" class="datepicker form-control">   
				</div>
				<div class="col-xs-6" id="div_end" style="display: none">
					Fin: <input type="text" name="end" id="end" class="datepicker form-control">
				</div>
			</div>
		{# </form> #}
	</div>

	<div class="col-xs-12">
		<div id="result"></div>		
	</div>

{% endblock %}
{% block stylesheets %}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highstock/6.0.1/css/highcharts.css" integrity="sha256-ji+33kRPEXS0+FM/AbApEs8n5kT2UBiGyk36zs1F9gE=" crossorigin="anonymous" />
{% endblock %}
{% block javascripts %}
	{# http://itsolutionstuff.com/post/simple-highcharts-chart-example-using-php-mysql-databaseexample.html #}
	{# <script src="https://code.highcharts.com/highcharts.js"></script> #}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highstock/6.0.1/highstock.js" integrity="sha256-ey/5yo1hzGfJgxENRS4EClXKyQPp6D+v/rYv+Dgn/2c=" crossorigin="anonymous"></script>
	{# Moment.js #}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment-with-locales.min.js" integrity="sha256-TbOIe++NbC9P3KTtUMJ5wcROlBdnRqrPleLdpPg3xxE=" crossorigin="anonymous"></script>

	{# chart.js #}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.min.js" integrity="sha256-UGwvyUFH6Qqn0PSyQVw4q3vIX0wV1miKTracNJzAWPc=" crossorigin="anonymous"></script>
	
	{# Google graph #}
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

	<script>
	$(function()
	{
		// Récuperer les commandes par boutique
		// Faire une boucle pour récuperer les éléments
		// Faire une somme des qté de produits par jours/mois/an/custum
		// Calculé le chiffre d'affaire par jours/mois/an/custum
		// Affiché les élément dans le graphique
		
		getDateTime();
		getData();

		$( ".datepicker" ).datepicker();

		var periode = $('#periode');
		var debut = $("#start");
		var fin = $("#end");
		var custom = $("#custom");
		var val_debut, val_fin, selected;

		periode.on("change", function()
		{
			selected = $(this).val();
			if(selected == 6)
			{
				custom.show();
			}
			else
			{
				custom.hide();
				val_debut = null;
				val_fin = null;
				getData(selected);
			}
		});

		debut.on("change", function()
		{
			val_debut = $(this).val();
			$("#div_end").show();
			fin.val("");
		
			fin.on("change", function()
			{
				val_fin = $(this).val();

				if (val_debut > val_fin) 
				{
					fin.val("");
				}
				else
				{
					getData(6, new Date(val_debut), new Date(val_fin));
				}
			});

		});

		// Lance la fonction après la durée rentrée, 5000 = 5 secondes //https://stackoverflow.com/questions/2170923/whats-the-easiest-way-to-call-a-function-every-5-seconds-in-jquery
		window.setInterval(function(){
			getData(selected, new Date(val_debut), new Date(val_fin));
			getDateTime();
		}, 5000);

	}); //Fin jquery

	function l(data){console.log(data)} //Console.log abreger
	function toStr(data){return JSON.stringify(data)} //Transforme une entrée d'object en string
	function getDateTime() //Récupere la date l'heure et les seconde actuelle
	{
		var dt = new Date(); 
		var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds(); 
		$('#date').html(time); 
	} 
	// https://www.youtube.com/playlist?list=PL0u86Fjj-xSvKKTm62ZFMDCYluO87E7Jl
	function getData(periode, debut, fin)
	{
		var dt = new Date(); 
		periode = periode || 1; //Défini la valeur par defaut pout la periode
		var an = dt.getFullYear();
		var mois = dt.getMonth();
		var jour = dt.getDate();

		switch(periode) // En fonction de la periode on modifie les paramettre
		{
			case 1: //Toutes les factures
				debut = dt.setFullYear((an - 2000), 0, 01);
				fin = dt.setFullYear((an + 2000), 12, 31);
				break;
			
			case 2: //Aujourd'hui
				debut = dt.setFullYear(an, mois, jour);
				fin = dt.setFullYear(an, mois, jour);

				break;
		
			case 3: //La semaine
				debut = dt.setFullYear(an, mois, jour);
				fin = dt.setFullYear(an, mois,(jour - 7));				
				break;
			
			case 4: //Le mois
				debut = dt.setFullYear(an, (mois - 1), jour);
				fin = dt.setFullYear(an, mois, jour);
				break;
			
			case 5: //L'année
				debut = dt.setFullYear((an - 1), mois, jour);
				fin = dt.setFullYear(an, mois, jour);
				break;

			case 6: //Custum
				debut = debut;
				fin = fin;
				break;
		}

		l(periode)
		l(debut)
		l(fin)
		
		$.get("{{ path('statistic', {'id': shop.id} ) }}", function(data)
		{	
			var i = 0;

			var res = '<table class="table table-responsive table-striped">'
			res += '<thead>'
			res += '<tr>'
			res += '<th>Référence</th>'
			res += '<th>Date</th>'
			res += '<th>Heure</th>'
			res += '<th>Client</th>'
			res += '<th>Ttc</th>'
			res += '<th>Marge</th>'
			res += '<th>Voir</th>'
			res += '</tr>'
			res += '</thead>'
			res += '<tbdoy id="data"'			
			res += '</tbdoy>'

			var item = [];

			$.each(data, function(index, el) 
			{
				if(new Date(index) >= debut && new Date(index) <= fin)
				{
					$.each(el, function(items, content) 
					{				
				
						res+= '<tr>';
						// Generate url : https://stackoverflow.com/questions/7626792/generating-routes-in-javascript-with-twig-and-symfony2
						var route = "{{ path('seller_orders_show', {'id': 'id'} ) }}";
						route = route.replace("id", items);
						l(route);
						// res += "<a href="+ route +">";

						$.each(content, function(key, val) 
						{
							res += '<td>';
							
								if(key == "id")
								{
									res += "<a href="+ route +">Voir</a>";
								}
								else if(key != "an" && key != "mois" && key != "jour")
								{
									res += val;
								}
							
							
							res += '</td>';

						});

						// res += "</a>";

						res+= '</tr>';


					});
				}
			});

			res += '</table>';

			// l(qte);
			// l(res);
			// $("#result").html(res);
			$("#result").html(res);
			// http://itsolutionstuff.com/post/simple-highcharts-chart-example-using-php-mysql-databaseexample.html
		})
		.fail(function(data)
		{
			l(toStr(data));
		})
	} //Fin getData

	</script>
{% endblock %}